{% extends "website/base.html" %} {% block content %} {{ form.media.css }}

<div class="row justify-content-center mt-4">
  <div class="col-lg-10">
    <div class="card shadow-sm">
      <div
        class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
      >
        <h3 class="mb-0">Create New Order</h3>
      </div>
      <div class="card-body">
        <form method="post" id="order-form">
          {% csrf_token %}

          <h5 class="mb-3 text-secondary border-bottom pb-2">Customer Info</h5>
          <div class="row mb-4">
            <div class="col-md-6">
              <label class="form-label fw-bold">Customer</label>
              {{ form.customer }}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Status</label>
              {{ form.status }}
            </div>
          </div>

          <h5 class="mb-3 text-secondary border-bottom pb-2">Order Items</h5>

          {% if formset.non_form_errors %}
          <div class="alert alert-danger">
            {% for error in formset.non_form_errors %} {{ error }} {% endfor %}
          </div>
          {% endif %} {{ formset.management_form }}

          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 45%">Product</th>
                  <th style="width: 15%">Quantity</th>
                  <th style="width: 20%">Price (₴)</th>
                  <th style="width: 5%" class="text-center">Action</th>
                </tr>
              </thead>
              <tbody id="items-table-body">
                {% for item_form in formset %}
                <tr class="item-row">
                  {% for hidden in item_form.hidden_fields %} {{ hidden }} {%
                  endfor %}

                  <td>
                    {% if item_form.product.errors %}
                    <div class="text-danger small">
                      {{ item_form.product.errors }}
                    </div>
                    {% endif %} {{ item_form.product }}
                  </td>
                  <td>
                    {{ item_form.quantity }} {% if item_form.quantity.errors %}
                    <div class="text-danger small">
                      {{ item_form.quantity.errors }}
                    </div>
                    {% endif %}
                  </td>
                  <td>{{ item_form.price }}</td>
                  <td class="text-center">
                    <div class="d-none">{{ item_form.DELETE }}</div>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger delete-row-btn"
                      title="Remove item"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="mb-4">
            <button
              type="button"
              class="btn btn-outline-primary"
              id="add-item-btn"
            >
              <i class="fa-solid fa-plus"></i> Add another product
            </button>
          </div>

          <div class="d-flex justify-content-end gap-2 border-top pt-3">
            <a href="{% url 'website:order_list' %}" class="btn btn-secondary"
              >Cancel</a
            >
            <button type="submit" class="btn btn-success px-4">
              Save Order
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="empty-form" class="d-none">
  <table>
    <tr class="item-row">
      {% for hidden in formset.empty_form.hidden_fields %} {{ hidden }} {%
      endfor %}
      <td>{{ formset.empty_form.product }}</td>
      <td>{{ formset.empty_form.quantity }}</td>
      <td>{{ formset.empty_form.price }}</td>
      <td class="text-center">
        <div class="d-none">{{ formset.empty_form.DELETE }}</div>
        <button
          type="button"
          class="btn btn-sm btn-outline-danger delete-row-btn"
        >
          <i class="fa-solid fa-trash"></i>
        </button>
      </td>
    </tr>
  </table>
</div>

{{ form.media.js }}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Більше не треба initSelect2() і $('select').each(...)
    // Django-select2 робить це сам при завантаженні сторінки!

    const addItemBtn = document.getElementById("add-item-btn");
    const tableBody = document.getElementById("items-table-body");
    const totalFormsInput = document.querySelector(
      'input[name$="-TOTAL_FORMS"]',
    );
    const emptyFormTemplate = document
      .getElementById("empty-form")
      .querySelector("tr");

    // ADD ROW LOGIC
    addItemBtn.addEventListener("click", function () {
      const count = parseInt(totalFormsInput.value);
      const newRow = emptyFormTemplate.cloneNode(true);

      newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, count);
      tableBody.appendChild(newRow);

      // === ВАЖЛИВА ЗМІНА ===
      // Новий рядок з'явився динамічно, тому авто-скрипт Django його не бачив.
      // Ми маємо вручну "пнути" бібліотеку, щоб вона оживила цей конкретний селект.
      const newSelect = newRow.querySelector("select");
      if (newSelect) {
        // Використовуємо вбудовану функцію плагіна.
        // Вона прочитає data-атрибути з HTML (які згенерував Python) і все налаштує.
        $(newSelect).djangoSelect2();
      }

      totalFormsInput.value = count + 1;
    });

    // DELETE ROW LOGIC (Без змін)
    tableBody.addEventListener("click", function (e) {
      const btn = e.target.closest(".delete-row-btn");
      if (!btn) return;

      const row = btn.closest("tr");
      const deleteCheckbox = row.querySelector(
        'input[type="checkbox"][name$="-DELETE"]',
      );

      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        row.style.display = "none";
      } else {
        row.remove();
      }
    });
  });
</script>
{% endblock %}
